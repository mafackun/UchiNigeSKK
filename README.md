# unskk (UchiNige-SKK)

## 概要
unskkは、Rust + Termionで実装されたシンプルかつ軽量なTUIベースの日本語入力ツールです。
一般的なIMのようにシステムへ常駐・統合するのではなく、静的バイナリとして単体で実行できる設計になっています。
そのためインライン入力には対応していませんが、ワンキーで変換結果をクリップボード等へ送出できます（これがUchiNige、打ち逃げの由来です。）。
SKKのすべての機能や完全な互換性を目指すのではなく、必要十分な機能に絞った軽量実装を目的としています。

---

## 特徴
- Rust + TermionによるTUI実装
- 静的リンクされた単体バイナリとして実行可能
- 複数のSKK-JISYO を同時にロード可能（事前にUTF-8へのエンコードが必要）
- システム常駐IMではなく、ワンショット入力向け
- ひらがな／カタカナ／Latin／Abbrev／漢字変換に対応
- 軽量設計
  - `unskk-x86_64-musl` のバイナリサイズ：約 540 KB
  - L 辞書ロード時の RSS：約 7 MB（vanilladpup-10.0.93-retroで実行した場合）


---

## 起動ラッパの例

環境変数によって動作を制御します。  
以下は、クリップボード入出力と辞書パスを設定した起動ラッパの例です。

```sh
#!/bin/sh

DIR="/path/to/binary"
BIN="$DIR/unskk-x86_64-musl"

# 変換結果の送出先
export CPY_TO="xclip -selection clipboard"

# unskk に入力する元
export CPY_FROM="xclip -selection clipboard -o"

# SKK 辞書のパス（: 区切りで複数指定可能）
export JISYO_PATH="$DIR/SKK-JISYO.L.utf8:$DIR/SKK-JISYO.foo.utf8"

exec "$BIN"
```

### 環境変数
- CPY_TO：変換結果を送出するコマンド
- CPY_FROM：ペースト元のコマンド
- JISYO_PATH：使用する SKK 辞書のパス（辞書のコードはUTF-8、:区切り）


---

## 使用方法

入力はモード駆動で行われ、現在の状態は常に画面下部のステータス行に表示されます。

---

## 画面構成

### 本文（バッファ）
- 編集対象のテキスト
- 複数行対応
- `Enter`により改行が挿入されます
- 行・列カーソルを持ち、自動スクロールします
- 行の折り返し表示は非対応 

### ステータス（下部 2 行）
1. 入力状態表示
2. バッファ情報表示

#### 入力状態表示の例
- `かな/半角記号`
- `カナ/全角`
- `かな ▽よみ`
- `かな ▼候補 [2/10]`
- `無変換/全角`
- `aあ ▽abbr`

#### バッファ情報表示
- `カーソル位置: (row, col)  総行数: N`
- `+undo` 表示時は Undo が可能

ローマ字はバッファではなくステータス行にのみ表示されます。（Latinモードを除く）

---

## フロントエンド操作（全モード共通）

- Ctrl+S：バッファ全文をCPY_TOで指定したコマンドへ送出してクリア（打ち逃げ機能）
- Ctrl+V：CPY_FROMで指定したコマンドからカーソル位置にテキストを貼り付け
- Esc：Undo（直前スナップショットへ戻す）
- Ctrl+D：バッファクリア
- Ctrl+R：画面再描画（ウィンドウサイズの変更後などに使用）
- Ctrl+Q：終了

Undo は送出・貼り付け・バッファクリアの直前にスナップショットを1つ保存する方式です。
その後に通常入力を行うとスナップショットは破棄されます。

---

## カーソル移動・編集

- ← / → / ↑ / ↓：カーソル移動
- Home / End：行頭／行末へ移動
- Backspace：カーソル左の文字を削除（行頭なら前行と結合）
- Delete：カーソル位置の文字を削除

マウスによる操作は非対応です。

---

## 入力モード

以下の入力モードを持ちます。

1. かなモード（デフォルト）
2. 変換モード
3. Latin モード（無変換）
4. Abbrev モード

---

## かなモード

### モード切替・サブモード
- Ctrl+L：Latin モードへ
- q：ひらがな／カタカナ切替
- /：Abbrevモード
- Ctrl+Z：半角／全角サブモード切替

### かな入力
- ローマ字をかなへ逐次変換（かな変換に無効なローマ字は即座に破棄；ただし途中一致するプレフィックスは保持されます）
- n は後続文字に応じて「ん」として確定します
- `Enter` は通常は改行（読み入力中は未変換確定）

### 読みの編集と変換
- 大文字(A-Z)：読み開始／送り仮名（状況依存）
  - 例：「話す」と変換するときには「HanaS（変換モードに移行、候補選択）u」と入力
  - 通常のSKKと異なる挙動に注意；たとえば「hAnaSu」のような入力はできない
- Space：変換開始（変換が存在する場合のみモード移行）
- Enter：未変換の読みをそのまま確定（無効な接辞'>'は削除される）
- Backspace：読み／ローマ字を1文字消去
  - 読みが空のときにBackspaceでかな入力に戻る

### 接頭辞・接尾辞
- かな入力モード中の、ローマ字が空の場合 `>` は接尾辞として扱われ、読みの開始に移行
- 読みの入力中の `>` は接頭辞として扱われ、変換候補があるとき、変換モードに移行
  - 例：「超」を入力したいとき、「Chou>」と入力すると変換モードに移行

### 読み中のカタカナ確定
- q：読みをカタカナとして本文へ確定（無効な接辞'>'は削除される）

---

## 変換モード

- Space：次候補（候補一覧の表示UIはありません；内部的には複数候補を保持しています）
- x：前候補
- Enter：選択中候補を確定
  - 送り仮名が子音を持つ場合、つぎのかな入力に押し戻される
- Ctrl+G：変換キャンセル（これまでの読みは破棄）

### 連続入力
- `>`：確定 + 接尾辞として読み開始
- 大文字(A-Z)：確定 + 次の読み開始
- q：確定 + カナ入力に移行
  - 送り仮名が母音である場合にはカタカナで出力
    - 例：「YoI(変換候補選択)q」で「良イ」
- その他文字：確定 + 通常入力
  - 送り仮名が子音を持つ場合、その母音で確定できる
    - 例：「話す」を入力するとき、「HanaS」で候補選択して u で確定

Backspace で読み状態へ戻ります。

---

## Latin モード

- ASCII を直接入力
- Ctrl+Z：半角／全角 ASCII 切替
- Ctrl+L：かなモードへ戻る

---

## Abbrev モード

- ASCII の読みを入力
- Space：変換開始
- Enter：未変換のまま確定
- Backspace：1文字削除（空ならかなへ）

---

## テキスト送出

- バッファは複数行を保持します
- 送出時は `\n` で連結されます
- 送出後、バッファはクリアされます

---

## 起動・運用上の注意

- 起動時にロードした辞書すべてのソート処理が行われます
- 辞書サイズ・数によっては起動コストが高くなります
- 頻繁に使う場合は常駐運用を推奨します

### 文字幅について

軽量化のため、文字幅は簡易テーブルで管理しています。  
そのため、使用するフォントや文字の種類によっては、カーソル位置と表示位置がずれる場合があります。

特に以下の場合にずれが発生する可能性があります：

- 特殊なUnicode文字
- 結合文字
- フォント依存で幅が変わる記号

---

## 辞書エンコードについて

unskk は UTF-8 エンコードされた SKK 辞書を前提としています。

既存辞書を変換する場合、iconv などで変換すると、
文字化けや行破損が発生する場合があります。

うまく変換できない場合は：

1. 辞書をブラウザで開く  
2. 表示内容をコピー  
3. UTF-8 で新規保存  

という方法が安全な場合があります。

---

## 実装上の注意

ローマ字変換テーブルおよび一部の内部テーブルは、
メモリ効率を優先してソート済み配列 + 二分探索で実装されています。

テーブルを編集する場合は：

- ソート順を維持する
- 重複エントリを作らない

ことに注意してください。

---

## 謝辞

本ツールの実装にあたり、以下を参考にしました。

- TUI 実装の参考  
  https://qiita.com/hatoo@github/items/905a19a98876e7446edf

また、実装検討や設計整理の過程で、
ChatGPT や Google Gemini などの AI サービスを補助的に利用しています。

---

## License

MIT License
SKK辞書はそれぞれの配布元ライセンスに従ってください
