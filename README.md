# unskk (UchiNigeSKK)

## 概要
unskkは、Rust + Termionで実装されたシンプルかつ軽量なTUIベースの日本語入力ツールです。

一般的なIMのようにシステムへ統合するのではなく、静的バイナリとして単体で実行できる設計になっています。

そのためインライン入力には対応していませんが、ワンキーで変換結果をクリップボード等へ送出できます（これがUchiNige、打ち逃げの由来です。）。

SKKのすべての機能や完全な互換性を目指すのではなく、必要十分な機能に絞った軽量実装を目的としています。

本ドキュメントはunskkを使用して作成されました。

---

## 特徴
- Rust + TermionによるTUI実装
- 静的リンクされた単体バイナリとして実行可能
- 複数のSKK-JISYO を同時にロード可能（事前にUTF-8へのエンコードが必要）
- システム常駐IMではなく、ワンショット入力向け
- ひらがな／カタカナ／Latin／Abbrev／漢字変換に対応
- 軽量設計
  - ターゲット `x86_64-unknown-linux-musl` のバイナリサイズ：約 550 KB
  - L辞書ロード時のRSS：約 7 MB（vanilladpup-10.0.93-retroで実行した場合）


---

## バイナリ配布について

unskk は静的リンクされた単体バイナリとして配布しています。

現在、以下のターゲット向けにバイナリを提供しています。

- `x86_64-unknown-linux-musl`

### インストール方法

1. GitHub Releases から対応するアーカイブをダウンロードします
2. 展開して `unskk` バイナリを取り出します
3. 実行権限を付与し、PATH の通った場所に配置します

例：

```sh
tar xzf unskk-0.1.0-x86_64-unknown-linux-musl.tar.gz
chmod +x unskk
mv unskk ~/.local/bin/
```

その後、以下で動作確認できます。

```sh
unskk --version
```

他のアーキテクチャ向けバイナリが必要な場合は、Issue で要望を教えてください。


---

## 起動

### 起動ラッパの例

環境変数によって動作を制御します。  
以下は、クリップボード入出力(xclip)と辞書パスを設定した起動ラッパの例です。

```sh
#!/bin/sh

DIR="/path/to/binary"
BIN="$DIR/unskk"

# コマンドを実行するシェル（指定したい場合）
export SHELL="sh"

# 変換結果の送出先
export CPY_TO="xclip -selection clipboard"

# unskk に入力する元
export CPY_FROM="xclip -selection clipboard -o"

# SKK 辞書のパス（: 区切りで複数指定可能、拡張子は任意です（UTF-8であればOK））
export JISYO_PATH="$DIR/SKK-JISYO.L.utf8:$DIR/SKK-JISYO.foo.utf8"

exec "$BIN"
```

### 環境変数
- `CPY_TO`：変換結果を送出するコマンド
- `CPY_FROM`：ペースト元のコマンド
- `JISYO_PATH`：使用する SKK 辞書のパス（辞書のコードは `UTF-8` 、`:`区切り）

`CPY_TO`と`CPY_FROM`は`$SHELL -c`によってパースされ実行されます。
  - 任意のコマンドが実行可能なのでコマンドや権限に注意して使用してください。

`JISYO_PATH`は無効なパスが含まれると起動時に失敗します（エラー終了します）。


### オプション(コマンドライン引数)

- `--version` `-v` `-V`：バージョンとビルドターゲットを表示
- helpオプションは必要性に対してサイズが大きいのでv0.2.0で削除されました。
   - このドキュメントを参照してください。

---

## 使用方法

入力はモード駆動で行われ、現在の状態は常に画面下部のステータス行に表示されます。

---

## 画面構成

### 本文（バッファ）
- 編集対象のテキスト
- 複数行対応
- `Enter`により改行が挿入されます
- 行・列カーソルを持ち、自動スクロールします
- カーソルのある行（アクティブ行）は常に最下に表示
  - ステータス行への視線移動の最小化、描画ロジックの単純化のため
- 論理行が存在しない物理行には空行記号`~`が表示
- 行の折り返し表示は非対応 

### ステータス（下部1行）
1. 入力状態表示（ミニバッファ）
2. バッファ情報表示
3. コードポイント表示

#### 入力状態表示の例
- `かな/半角記号`
- `カナ/全角`
- `かな ▽よみ`
- `かな ▼候補 [2/10] 註: annotation`
- `無変換/全角`
- `aあ ▽abbr`

#### バッファ情報表示
- `(アクティブ行/総行数,*範囲選択の起点列:カーソル列)`
  - カーソル移動やフロントエンド操作を行ったときのみ表示
  - *は範囲選択時のみの表示
- `+undo` 表示時は Undo が可能

#### コードポイント表示
- `[U+61]`
  - フロントエンドでのキー入力による
  - 数値のゼロパディングはなし

ローマ字はバッファではなくステータス行にのみ表示されます。（Latinモードを除く）

---

## フロントエンド操作（全モード共通）

- `Ctrl+S`：バッファ全文を`CPY_TO`で指定したコマンドへ送出してクリア（打ち逃げ機能）
- `Ctrl+C`：選択範囲を`CPY_TO`で指定したコマンドへ送出
- `Ctrl+X`：選択範囲を切り取って`CPY_TO`で指定したコマンドへ送出
- `Ctrl+V`：`CPY_FROM`で指定したコマンドからカーソル位置にテキストを貼り付け
- `Esc`：Undo（直前スナップショットへ戻す）
- `Ctrl+D`：バッファクリア
- `Ctrl+R`：画面再描画（ウィンドウサイズの変更後に必ず使用）
- `Ctrl+B`：カーソル位置の文字のコードポイントをステータスに表示
- `Ctrl+Q`：終了

Undo は送出・貼り付け・バッファクリアの直前にスナップショットを1つ保存する方式です。
その後に通常入力を行うとスナップショットは破棄されます。

---

## カーソル移動・編集

### カーソル
- `← / → / ↑ / ↓`：カーソル移動（本文に対してのみ有効）
- `Home / End`：行頭／行末へ移動（本文に対してのみ有効）
- `PgUp / PgDown`：高速の行スクロール（本文に対してのみ有効）
  - 総行数の10%分スクロール、ただし行数が50行未満なら5行スクロール
- `Shift + ← / Shift + →`：範囲選択（本文に対してのみ有効）
  - 範囲選択はアクティブ行内のみで可能、行を跨ぐ選択はできません
  - その他のカーソル移動を行うと範囲選択は解除
  - 範囲選択中に文字や文字列の挿入操作をすると、選択範囲の文字が上書きされます

### 削除
- `Backspace`：カーソル左の文字を削除（行頭なら前行と結合）
  - ミニバッファに対して優先的に適用（状況により、ローマ字→読み→本文の順に消えます）
- `Delete`：カーソル位置の文字を削除（行末なら次行と結合、本文に対してのみ有効）

マウスによる操作は非対応です。

---

## 入力モード

以下の入力モードを持ちます。

1. かなモード（デフォルト）
2. 変換モード
3. Latin モード（無変換）
4. Abbrev モード

---

## かなモード

### モード切替・サブモード
- `Ctrl+L`：Latin モードへ
- `q`：ひらがな／カタカナ切替
- `/`：Abbrevモード
- `Ctrl+Z`：半角／全角サブモード切替

### かな入力
- ローマ字をかなへ逐次変換（かな変換に無効なローマ字は即座に破棄；ただし途中一致するプレフィックスは保持されます）
- n は後続文字に応じて「ん」として確定します
- `Enter` は通常は改行（読み入力中は未変換確定）

### 読みの編集と変換
- `大文字(A-Z)`：読み開始／送り仮名（状況依存）
  - 例：「話す」と変換するときには「HanaS（変換モードに移行、候補選択）u」と入力
  - 通常のSKKと異なる挙動に注意；たとえば「hAnaSu」のような入力は不可
- `Space`：変換開始（変換が存在する場合のみモード移行）
- `Enter`：未変換の読みをそのまま確定（無効な接辞'>'は削除される）
- `Backspace`：読み／ローマ字を1文字消去
  - 読みが空のときに`Backspace`でかな入力に戻る

### 接頭辞・接尾辞
- かな入力モード中の、ローマ字が空の場合 `>` は接尾辞として扱われ、読みの開始に移行
- 読みの入力中の `>` は接頭辞として扱われ、変換候補があるとき、変換モードに移行
  - 例：「超」を入力したいとき、「Chou>」と入力すると変換モードに移行
- かなモードでは`>`を入力出来ないのでAbbrevモードなどを使用します

### 読み中のカタカナ確定
- `q`：読みをカタカナとして本文へ確定（無効な接辞'>'は削除される）

---

## 変換モード

- `Space`：次候補（候補一覧の表示UIはありません；内部的には複数候補を保持しています）
- `x`：前候補
- `Enter`：選択中候補を確定
  - 送り仮名が子音を持つ場合、つぎのかな入力に押し戻される
- `Ctrl+G`：変換キャンセル（候補確定せず、読み入力に戻る）

### 連続入力
- `>`：確定 + 接尾辞として読み開始
- `大文字(A-Z)`：確定 + 次の読み開始
- `/`：確定 + Abbrevモード開始
- `q`：確定 + カナ入力に移行
  - 送り仮名が母音である場合にはカタカナで出力
    - 例：「YoI(変換候補選択)q」で「良イ」
- `Backspace`：選択中候補を確定してから一文字削除
- `その他文字`：確定 + 通常入力
  - 送り仮名が子音を持つ場合、その母音で確定できる
    - 例：「話す」を入力するとき、「HanaS」で候補選択して u で確定

---

## Latin モード

- ASCII を直接入力
- `Ctrl+Z`：半角／全角 ASCII 切替
- `Ctrl+L`：かなモードへ戻る

---

## Abbrev モード

- ASCII の読みを入力
- `Space`：変換開始
- `Enter`：未変換のまま確定
- `Backspace`：1文字削除（空ならかなモードへ）

---

## テキスト送出

- バッファは複数行を保持します
- 送出時は `\n` で連結されます
- 送出後、バッファはクリアされます

---

## 起動・運用上の注意

- 起動時にロードした辞書すべてのソート処理が行われます
- 辞書サイズ・数によっては起動コストが高くなります
  - 環境に応じて辞書サイズを選択してください
- 頻繁に使う場合は常駐運用を推奨します

---

## ターミナルのサイズについて

- 表示崩れ防止のため、ウィンドウをリサイズ後には必ず`Ctrl+R`で再描画をしてください
  - 自動で再描画は行われません
- ターミナルのサイズが小さすぎる場合には`RESIZE_AND_REFRESH`と表示されます
  - このとき再描画と終了以外のキー入力を拒否します
  - ウィンドウサイズを変更し、再描画キーを押下してください
  - 通常使用可能な最小のターミナルサイズは2行、36列です
- ステータス行は画面から溢れた文字を切り捨てます
  - 列数は最小値よりも大きい値を推奨します

---

## 文字幅について

- East Asian Ambiguous Widthは幅1扱い
- 制御文字や表示崩れのある文字は置換して表示
  - `TAB`：`\t` に置換
  - その他：`\?`に置換
  - 置換された文字の判別にはコードポイント表示機能を使用してください

軽量化のため、文字幅は簡易テーブルで管理しています。  

使用するフォントや文字の種類によっては、表示が崩れる場合があります。


---

## 辞書について

unskkは`UTF-8`エンコードされた SKK 辞書を前提としています。

既存辞書を変換する場合、iconvなどで変換すると、文字化けや行破損が発生する場合があります。

うまく変換できない場合は：

1. 辞書をブラウザで開く  
2. 表示内容をコピー  
3. `UTF-8`で新規保存  

という方法が安全な場合があります。

辞書の書式が正常でない場合には起動に失敗することがあります。
エントリは`読み /候補1/候補2/.../`という書式にしてください。
「読み」と'/'の間は必ず半角スペースを置いてください。


辞書の「読み」が同一のエントリが複数存在する場合、最初にマッチしたエントリの候補リストしか取得しません。

---

## エラーメッセージについて

エラーが発生すると、エラーメッセージを標準エラー出力して終了します。
ただし、UI表示の都合上、画面にはエラーメッセージが表示されない可能性があります。

エラーメッセージを参照するには、以下の起動スクリプトを参考にしてください。

- エラーをファイルに出力する
``` sh
unskk 2> /some/path/unskk_error
```

- エラーをファイルに出力して、それを表示、表示後に削除する
```sh
unskk 2> unskk_error || cat unskk_error && rm unskk_error
```

---

## 実装上の注意

ローマ字変換テーブルおよび一部の内部テーブルは、
メモリ効率を優先してソート済み配列 + 二分探索で実装されています。

テーブルを編集する場合は：

- ソート順を維持する
- 重複エントリを作らない

ことに注意してください。

---

## 謝辞

本ツールの実装にあたり、以下を参考にしました。

- TUI 実装の参考  
  https://qiita.com/hatoo@github/items/905a19a98876e7446edf

また、実装検討や設計整理の過程で、
ChatGPT や Google Gemini などの AI サービスを補助的に利用しています。

---

## License

This project is licensed under the MIT License.

SKK辞書はそれぞれの配布元ライセンスに従ってください
